openapi: 3.1.0
info:
  title: Hypeman API
  description: Generic API for managing VM lifecycle using Cloud Hypervisor with OCI-based workloads
  version: 0.1.0
servers:
  - url: http://localhost:8080
    description: Local development server
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
  schemas:
    ErrorDetail:
      type: object
      properties:
        code:
          type: string
          description: Lower-level error code providing more specific detail
          example: invalid_input
        message:
          type: string
          description: Further detail about the error
          example: Image not found
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          description: Application-specific error code (machine-readable)
          example: bad_request
        message:
          type: string
          description: Human-readable error description for debugging
          example: "Missing required field: image"
        details:
          type: array
          description: Additional error details (for multiple errors)
          items:
            $ref: "#/components/schemas/ErrorDetail"
        inner_error:
          $ref: "#/components/schemas/ErrorDetail"
    
    InstanceState:
      type: string
      enum: [Created, Running, Paused, Shutdown, Stopped, Standby]
      description: |
        Instance state:
        - Created: VMM created but not started (Cloud Hypervisor native)
        - Running: VM is actively running (Cloud Hypervisor native)
        - Paused: VM is paused (Cloud Hypervisor native)
        - Shutdown: VM shut down but VMM exists (Cloud Hypervisor native)
        - Stopped: No VMM running, no snapshot exists
        - Standby: No VMM running, snapshot exists (can be restored)
    
    VolumeAttachment:
      type: object
      required: [volume_id, mount_path]
      properties:
        volume_id:
          type: string
          description: Volume identifier
          example: vol-abc123
        mount_path:
          type: string
          description: Path where volume is mounted in the guest
          example: /mnt/data
        readonly:
          type: boolean
          description: Whether volume is mounted read-only
          default: false
    
    PortMapping:
      type: object
      required: [host_port, guest_port]
      properties:
        host_port:
          type: integer
          description: Port on the host
          example: 8080
        guest_port:
          type: integer
          description: Port in the guest VM
          example: 80
        protocol:
          type: string
          enum: [tcp, udp]
          default: tcp
    
    CreateInstanceRequest:
      type: object
      required: [name, image]
      properties:
        name:
          type: string
          description: Human-readable name (lowercase letters, digits, and dashes only; cannot start or end with a dash)
          pattern: ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$
          maxLength: 63
          example: my-workload-1
        image:
          type: string
          description: OCI image reference
          example: docker.io/library/alpine:latest
        size:
          type: string
          description: Base memory size (human-readable format like "1GB", "512MB", "2G")
          default: "1GB"
          example: "2GB"
        hotplug_size:
          type: string
          description: Additional memory for hotplug (human-readable format like "3GB", "1G")
          default: "3GB"
          example: "2GB"
        overlay_size:
          type: string
          description: Writable overlay disk size (human-readable format like "10GB", "50G")
          default: "10GB"
          example: "20GB"
        vcpus:
          type: integer
          description: Number of virtual CPUs
          default: 2
          example: 2
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables
          example:
            PORT: "3000"
            NODE_ENV: production
        network:
          type: string
          description: Network to attach instance to (defaults to "default", use empty string for no network)
          default: "default"
          example: "default"
        # Future: volumes, port_mappings, timeout_seconds
    
    Instance:
      type: object
      required: [id, name, image, state, created_at]
      properties:
        id:
          type: string
          description: Auto-generated unique identifier (CUID2 format)
          example: tz4a98xxat96iws9zmbrgj3a
        name:
          type: string
          description: Human-readable name
          example: my-workload-1
        image:
          type: string
          description: OCI image reference
          example: docker.io/library/alpine:latest
        state:
          $ref: "#/components/schemas/InstanceState"
        size:
          type: string
          description: Base memory size (human-readable)
          example: "2GB"
        hotplug_size:
          type: string
          description: Hotplug memory size (human-readable)
          example: "2GB"
        overlay_size:
          type: string
          description: Writable overlay disk size (human-readable)
          example: "10GB"
        vcpus:
          type: integer
          description: Number of virtual CPUs
          example: 2
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables
        network:
          type: string
          description: Network name the instance is attached to (empty string if no network)
          example: "default"
        ip:
          type: string
          description: Assigned IP address (null if no network)
          example: "192.168.100.10"
          nullable: true
        mac:
          type: string
          description: Assigned MAC address (null if no network)
          example: "02:00:00:ab:cd:ef"
          nullable: true
        created_at:
          type: string
          format: date-time
          description: Creation timestamp (RFC3339)
          example: "2025-01-15T10:30:00Z"
        started_at:
          type: string
          format: date-time
          description: Start timestamp (RFC3339)
          example: "2025-01-15T10:30:05Z"
          nullable: true
        stopped_at:
          type: string
          format: date-time
          description: Stop timestamp (RFC3339)
          example: "2025-01-15T12:30:00Z"
          nullable: true
        has_snapshot:
          type: boolean
          description: Whether a snapshot exists for this instance
          example: false
    
    CreateImageRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: OCI image reference (e.g., docker.io/library/nginx:latest)
          example: docker.io/library/nginx:latest
    
    Image:
      type: object
      required: [name, digest, status, created_at]
      properties:
        name:
          type: string
          description: Normalized OCI image reference (tag or digest)
          example: docker.io/library/nginx:latest
        digest:
          type: string
          description: Resolved manifest digest
          example: sha256:abc123def456...
        status:
          type: string
          enum: [pending, pulling, converting, ready, failed]
          description: Build status
          example: ready
        queue_position:
          type: integer
          description: Position in build queue (null if not queued)
          example: 2
          nullable: true
        error:
          type: string
          description: Error message if status is failed
          example: "pull failed: connection timeout"
          nullable: true
        size_bytes:
          type: integer
          format: int64
          description: Disk size in bytes (null until ready)
          example: 536870912
          nullable: true
        entrypoint:
          type: array
          items:
            type: string
          description: Entrypoint from container metadata
          example: ["/docker-entrypoint.sh"]
          nullable: true
        cmd:
          type: array
          items:
            type: string
          description: CMD from container metadata
          example: ["nginx", "-g", "daemon off;"]
          nullable: true
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables from container metadata
          example:
            PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        working_dir:
          type: string
          description: Working directory from container metadata
          example: /app
          nullable: true
        created_at:
          type: string
          format: date-time
          description: Creation timestamp (RFC3339)
          example: "2025-01-15T10:00:00Z"
    
    CreateVolumeRequest:
      type: object
      required: [name, size_gb]
      properties:
        id:
          type: string
          description: Optional custom identifier (auto-generated if not provided)
          example: vol-data-1
        name:
          type: string
          description: Volume name
          example: my-data-volume
        size_gb:
          type: integer
          description: Size in gigabytes
          example: 10
    
    Volume:
      type: object
      required: [id, name, size_gb, created_at]
      properties:
        id:
          type: string
          description: Unique identifier
          example: vol-data-1
        name:
          type: string
          description: Volume name
          example: my-data-volume
        size_gb:
          type: integer
          description: Size in gigabytes
          example: 10
        attached_to:
          type: string
          description: Instance ID if attached
          example: inst-abc123
          nullable: true
        mount_path:
          type: string
          description: Mount path if attached
          example: /mnt/data
          nullable: true
        created_at:
          type: string
          format: date-time
          description: Creation timestamp (RFC3339)
          example: "2025-01-15T09:00:00Z"
    
    AttachVolumeRequest:
      type: object
      required: [mount_path]
      properties:
        mount_path:
          type: string
          description: Path where volume should be mounted
          example: /mnt/data
        readonly:
          type: boolean
          description: Mount as read-only
          default: false
    
    Network:
      type: object
      required: [name, subnet, gateway, bridge, isolated, default]
      properties:
        name:
          type: string
          description: Network name
          example: "default"
        subnet:
          type: string
          description: Subnet in CIDR notation
          example: "192.168.100.0/24"
        gateway:
          type: string
          description: Gateway IP address
          example: "192.168.100.1"
        bridge:
          type: string
          description: Bridge interface name
          example: "vmbr0"
        isolated:
          type: boolean
          description: Whether instances are isolated (bridge_slave mode)
          example: true
        dns_domain:
          type: string
          description: DNS domain for this network
          example: "hypeman"
        default:
          type: boolean
          description: Whether this is the default network
          example: true
        created_at:
          type: string
          format: date-time
          description: Creation timestamp (RFC3339)
          example: "2025-01-15T10:00:00Z"
    
    CreateNetworkRequest:
      type: object
      required: [name, subnet]
      properties:
        name:
          type: string
          description: Network name (lowercase letters, digits, and dashes only)
          pattern: ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$
          maxLength: 63
          example: "internal"
        subnet:
          type: string
          description: Subnet in CIDR notation
          example: "192.168.101.0/24"
        isolated:
          type: boolean
          description: Whether to enable bridge_slave isolation (prevents VM-to-VM communication)
          default: true
          example: true
    
    Health:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [ok]
          example: ok

paths:
  /health:
    get:
      summary: Health check
      operationId: getHealth
      responses:
        200:
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Health"
  
  /networks:
    get:
      summary: List networks
      operationId: listNetworks
      security:
        - bearerAuth: []
      responses:
        200:
          description: List of networks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Network"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create network
      operationId: createNetwork
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateNetworkRequest"
      responses:
        201:
          description: Network created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Network"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /networks/{name}:
    get:
      summary: Get network details
      operationId: getNetwork
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          example: "default"
      responses:
        200:
          description: Network details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Network"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: Network not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete network
      operationId: deleteNetwork
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          example: "internal"
      responses:
        204:
          description: Network deleted
        400:
          description: Cannot delete default network
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: Network not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Network has active instances
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /images:
    get:
      summary: List images
      operationId: listImages
      security:
        - bearerAuth: []
      responses:
        200:
          description: List of images
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Image"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Pull and convert OCI image
      operationId: createImage
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateImageRequest"
      responses:
        202:
          description: Image build started (async)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Image"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: Image not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /images/{name}:
    get:
      summary: Get image details
      operationId: getImage
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: URL-encoded image name (e.g. docker.io%2Flibrary%2Falpine%3Alatest)
      responses:
        200:
          description: Image details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Image"
        404:
          description: Image not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete image
      operationId: deleteImage
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: URL-encoded image name
      responses:
        204:
          description: Image deleted
        404:
          description: Image not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances:
    get:
      summary: List instances
      operationId: listInstances
      security:
        - bearerAuth: []
      responses:
        200:
          description: List of instances
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Instance"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create and start instance
      operationId: createInstance
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateInstanceRequest"
      responses:
        201:
          description: Instance created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}:
    get:
      summary: Get instance details
      operationId: getInstance
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Instance details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Stop and delete instance
      operationId: deleteInstance
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        204:
          description: Instance deleted
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/standby:
    post:
      summary: Put instance in standby (pause, snapshot, delete VMM)
      operationId: standbyInstance
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Instance in standby
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - instance not in correct state
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/restore:
    post:
      summary: Restore instance from standby
      operationId: restoreInstance
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Instance restored
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - instance not in standby or no snapshot
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/logs:
    get:
      summary: Stream instance logs (SSE)
      operationId: getInstanceLogs
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: follow
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Follow logs (stream with SSE)
        - name: tail
          in: query
          required: false
          schema:
            type: integer
            default: 100
          description: Number of lines to return from end
      responses:
        200:
          description: Log stream
          content:
            text/event-stream:
              schema:
                type: string
            text/plain:
              schema:
                type: string
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/volumes/{volumeId}:
    post:
      summary: Attach volume to instance
      operationId: attachVolume
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: volumeId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AttachVolumeRequest"
      responses:
        200:
          description: Volume attached
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance or volume not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - volume already attached
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Detach volume from instance
      operationId: detachVolume
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: volumeId
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Volume detached
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance or volume not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /volumes:
    get:
      summary: List volumes
      operationId: listVolumes
      security:
        - bearerAuth: []
      responses:
        200:
          description: List of volumes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Volume"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create volume
      operationId: createVolume
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateVolumeRequest"
      responses:
        201:
          description: Volume created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Volume"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /volumes/{id}:
    get:
      summary: Get volume details
      operationId: getVolume
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Volume details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Volume"
        404:
          description: Volume not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete volume
      operationId: deleteVolume
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        204:
          description: Volume deleted
        404:
          description: Volume not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - volume is attached
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

